version: "3"

tasks:
  default:
    cmds:
      - task --list

  install.bin_deps:
    desc: "Install dependencies for application work"
    cmds:
      - go install github.com/pressly/goose/v3/cmd/goose@v3.24.3

  migrate.up:
    desc: "Apply migrations"
    cmds:
      - goose -dir migrations postgres "postgres://order_service_user:Passw0rd@localhost:5435/order_db?sslmode=disable" up

  lint:
    desc: "Activate linters"
    cmds:
      - golangci-lint cache clean
      - golangci-lint run ./...

  tidy:
    desc: "Cleaning go mod"
    cmds:
      - go mod tidy

  generator.run:
    desc: "Run order generator"
    cmds:
      - |
        if [ ! -f "{{.TASKFILE_DIR}}/third_party/order_generator" ]; then
          echo "Building order generator..."
          go build -o "{{.TASKFILE_DIR}}/third_party/order_generator" "{{.TASKFILE_DIR}}/third_party"
        fi
      - "{{.TASKFILE_DIR}}/third_party/order_generator"

  unit:
    desc: "Run unit tests with coverage"
    cmds:
      - go test -race --tags=unit -coverprofile={{.TASKFILE_DIR}}/coverage.out ./...
      - go tool cover -html={{.TASKFILE_DIR}}/coverage.out
      - rm -rf {{.TASKFILE_DIR}}/coverage.out